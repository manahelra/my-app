<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„ÙƒØ§Ø´ÙŠØ± Ø§Ù„Ù…Ø·ÙˆØ± - Ù†Ø³Ø®Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´Ø§Ù…Ù„</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4361ee; --success: #2ec4b6; --danger: #e63946;
            --warning: #f8961e; --bg: #f4f7fe; --card: #ffffff; --text: #2b2d42; --border: #eee;
        }
        .dark-mode {
            --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --border: #333;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Tajawal', sans-serif; transition: 0.2s; }
        body { background-color: var(--bg); color: var(--text); padding: 15px; }
        .container { max-width: 1300px; margin: 0 auto; }
        .bismillah { text-align: center; font-size: 1.8rem; font-weight: bold; margin-bottom: 20px; }

        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: var(--card); padding: 15px; border-radius: 12px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-top: 5px solid var(--primary); }
        .stat-card p { font-size: 1.4rem; font-weight: bold; color: var(--primary); margin-top: 5px; }

        /* Tabs */
        .tabs { display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; background: var(--card); padding: 10px; border-radius: 12px; }
        .tab { padding: 12px 20px; cursor: pointer; border-radius: 8px; font-weight: bold; border: none; background: rgba(0,0,0,0.05); color: var(--text); white-space: nowrap; }
        .tab.active { background: var(--primary); color: white; }
        .tab-content { display: none; background: var(--card); padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .tab-content.active { display: block; }

        /* Forms */
        .input-group { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; background: rgba(0,0,0,0.02); padding: 15px; border-radius: 10px; position: relative; border: 1px solid var(--border); }
        input { padding: 10px; border: 1px solid var(--border); border-radius: 8px; flex: 1; min-width: 130px; background: var(--card); color: var(--text); }
        .btn { padding: 10px 18px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 6px; color: white; }
        .btn-primary { background: var(--primary); }
        .btn-success { background: var(--success); }
        .btn-danger { background: var(--danger); }
        .btn-warning { background: var(--warning); }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; border-bottom: 1px solid var(--border); text-align: center; }
        th { background: rgba(0,0,0,0.03); }

        /* Suggestions */
        .suggestions { position: absolute; top: 70px; right: 15px; left: 15px; background: var(--card); border: 1px solid var(--border); z-index: 1000; border-radius: 8px; display: none; max-height: 200px; overflow-y: auto; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .sug-item { padding: 12px; cursor: pointer; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; }
        .sug-item:hover { background: var(--primary); color: white; }

        @media print { .no-print { display: none !important; } .tab-content { display: none !important; } #shopping-tab { display: block !important; } }
    </style>
</head>
<body>

<div class="container">
    <div class="header-top no-print" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <button class="btn btn-primary" onclick="toggleDarkMode()"><i class="fas fa-moon"></i> ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¸Ù‡Ø±</button>
        <div class="bismillah">Ø¨Ø³Ù… Ø§Ù„Ù„Ù‡ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø±Ø­ÙŠÙ…</div>
        <div style="width:120px"></div>
    </div>

    <div class="stats-grid no-print">
        <div class="stat-card"><h3>Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h3><p id="stat-today">0</p></div>
        <div class="stat-card"><h3>Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h3><p id="stat-exp">0</p></div>
        <div class="stat-card"><h3>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</h3><p id="stat-profit" style="color:var(--success)">0</p></div>
        <div class="stat-card"><h3>Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø²Ù†</h3><p id="stat-inv-val" style="color:var(--warning)">0</p></div>
    </div>

    <div class="tabs no-print">
        <button class="tab active" onclick="showTab('pos')">ğŸ›’ Ø§Ù„ÙƒØ§Ø´ÙŠØ±</button>
        <button class="tab" onclick="showTab('inv')">ğŸ“¦ Ø§Ù„Ù…Ø®Ø²Ù†</button>
        <button class="tab" onclick="showTab('shopping')">ğŸ“ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</button>
        <button class="tab" onclick="showTab('exp')">ğŸ’¸ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</button>
        <button class="tab" onclick="showTab('archive')">ğŸ“œ Ø§Ù„Ø£Ø±Ø´ÙŠÙ</button>
    </div>

    <div id="pos-tab" class="tab-content active">
        <div class="input-group no-print">
            <input type="hidden" id="pos-edit-id">
            <input type="text" id="pos-in" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† ØµÙ†Ù Ù„Ø¨ÙŠØ¹Ù‡..." onkeyup="searchPOS(this.value)">
            <input type="number" id="pos-q" value="1" min="1" style="max-width: 80px;">
            <button class="btn btn-success" id="pos-btn" onclick="sellNow()">Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¨ÙŠØ¹</button>
            <div id="pos-sug" class="suggestions"></div>
        </div>
        <table>
            <thead><tr><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø³Ø¹Ø± Ø§Ù„Ø­Ø¨Ø©</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
            <tbody id="today-sales-body"></tbody>
        </table>
    </div>

    <div id="inv-tab" class="tab-content">
        <div class="input-group">
            <input type="hidden" id="inv-edit-id">
            <input type="text" id="inv-n" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
            <input type="number" id="inv-q" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
            <input type="number" id="inv-m" placeholder="Ø­Ø¯ Ø§Ù„Ù†Ù‚Øµ">
            <input type="number" id="inv-buy" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡">
            <input type="number" id="inv-sell" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹">
            <button class="btn btn-primary" id="inv-btn" onclick="saveInventory()">Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ù…Ø®Ø²Ù†</button>
        </div>
        <div class="input-group no-print">
            <input type="text" id="inv-search-input" placeholder="Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹ ÙÙŠ Ø§Ù„Ù…Ø®Ø²Ù†..." onkeyup="renderInventory(this.value)">
        </div>
        <table>
            <thead><tr><th>Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø´Ø±Ø§Ø¡</th><th>Ø¨ÙŠØ¹</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
            <tbody id="inventory-body"></tbody>
        </table>
    </div>

    <div id="shopping-tab" class="tab-content">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
            <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</h3>
            <button class="btn btn-primary no-print" onclick="window.print()">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="no-print"><h4>Ø§Ù„Ù†ÙˆØ§Ù‚Øµ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©</h4><table id="auto-low-body"></table></div>
            <div><h4>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©</h4><table id="final-shop-body"></table></div>
        </div>
    </div>

    <div id="exp-tab" class="tab-content">
        <div class="input-group">
            <input type="hidden" id="exp-edit-id">
            <input type="text" id="exp-n" placeholder="Ø¨ÙŠØ§Ù† Ø§Ù„Ù…ØµØ±Ù">
            <input type="number" id="exp-a" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
            <button class="btn btn-danger" id="exp-btn" onclick="saveExpense()">Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ</button>
        </div>
        <table>
            <thead><tr><th>Ø§Ù„Ø¨ÙŠØ§Ù†</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
            <tbody id="expense-body"></tbody>
        </table>
    </div>

    <div id="archive-tab" class="tab-content">
        <div id="archive-list"></div>
    </div>
</div>

<script>
    let db = JSON.parse(localStorage.getItem('mega_pos_v13')) || {
        inventory: [], expenses: [], today: [], archive: [], shopping: [],
        lastDate: new Date().toLocaleDateString()
    };

    function save() { localStorage.setItem('mega_pos_v13', JSON.stringify(db)); renderAll(); }

    function toggleDarkMode() {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('darkV13', document.body.classList.contains('dark-mode'));
    }

    function showTab(id) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(id + '-tab').classList.add('active');
        event.currentTarget.classList.add('active');
    }

    // --- Ø§Ù„ÙƒØ§Ø´ÙŠØ± (Ø¥Ø¶Ø§ÙØ© ÙˆØªØ¹Ø¯ÙŠÙ„ ÙˆØ­Ø°Ù) ---
    function searchPOS(v) {
        const box = document.getElementById('pos-sug');
        if(!v) { box.style.display='none'; return; }
        const ms = db.inventory.filter(i => i.name.includes(v));
        box.innerHTML = ms.map(i => `<div class="sug-item" onclick="setPOS('${i.name}')"><span>${i.name}</span><span>(${i.qty})</span></div>`).join('');
        box.style.display = ms.length ? 'block' : 'none';
    }
    function setPOS(n) { document.getElementById('pos-in').value = n; document.getElementById('pos-sug').style.display='none'; }

    function sellNow() {
        const editId = document.getElementById('pos-edit-id').value;
        const n = document.getElementById('pos-in').value;
        const q = parseInt(document.getElementById('pos-q').value) || 1;
        const i = db.inventory.find(x => x.name === n);

        if(!i) { alert("Ø§Ù„ØµÙ†Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!"); return; }

        if(editId) {
            // Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø«Ù… Ø®ØµÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯
            const oldSale = db.today.find(s => s.id == editId);
            const oldItem = db.inventory.find(inv => inv.name === oldSale.name);
            oldItem.qty += oldSale.qty; // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„Ù„Ù…Ø®Ø²Ù†

            if(i.qty < q) { alert("Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©!"); oldItem.qty -= oldSale.qty; return; }
            
            i.qty -= q; // Ø®ØµÙ… Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            const idx = db.today.findIndex(s => s.id == editId);
            db.today[idx] = { ...oldSale, name: n, qty: q, unitPrice: i.sell, totalPrice: i.sell * q };
            
            document.getElementById('pos-edit-id').value = "";
            document.getElementById('pos-btn').innerText = "Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¨ÙŠØ¹";
            document.getElementById('pos-btn').className = "btn btn-success";
        } else {
            // Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯Ø©
            if(i.qty < q) { alert("Ø§Ù„ÙƒÙ…ÙŠØ© ØºÙŠØ± ÙƒØ§ÙÙŠØ©!"); return; }
            i.qty -= q;
            db.today.unshift({ 
                id: Date.now(),
                time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}), 
                name: n, qty: q, unitPrice: i.sell, totalPrice: i.sell * q 
            });
        }
        document.getElementById('pos-in').value = '';
        document.getElementById('pos-q').value = '1';
        save();
    }

    function editSale(id) {
        const sale = db.today.find(s => s.id == id);
        document.getElementById('pos-edit-id').value = sale.id;
        document.getElementById('pos-in').value = sale.name;
        document.getElementById('pos-q').value = sale.qty;
        document.getElementById('pos-btn').innerText = "ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ¹Ø©";
        document.getElementById('pos-btn').className = "btn btn-warning";
    }

    function deleteSale(id) {
        if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ¹Ø© ÙˆØ¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ÙƒÙ…ÙŠØ© Ù„Ù„Ù…Ø®Ø²Ù†ØŸ")) {
            const sale = db.today.find(s => s.id == id);
            const item = db.inventory.find(i => i.name === sale.name);
            if(item) item.qty += sale.qty;
            db.today = db.today.filter(s => s.id != id);
            save();
        }
    }

    // --- Ø§Ù„Ù…Ø®Ø²Ù† ÙˆØ§Ù„Ù…ØµØ±ÙˆÙØ§Øª (Ù†ÙØ³ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø§Ù„Ù…Ø³ØªÙ‚Ø±) ---
    function saveInventory() {
        const id = document.getElementById('inv-edit-id').value;
        const n = document.getElementById('inv-n').value, q = parseInt(document.getElementById('inv-q').value),
              m = parseInt(document.getElementById('inv-m').value), b = parseFloat(document.getElementById('inv-buy').value),
              s = parseFloat(document.getElementById('inv-sell').value);
        if(!n) return;
        if(id) {
            const idx = db.inventory.findIndex(x => x.id == id);
            db.inventory[idx] = { id: parseInt(id), name: n, qty: q, min: m, buy: b, sell: s };
            document.getElementById('inv-edit-id').value = "";
            document.getElementById('inv-btn').innerText = "Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ù…Ø®Ø²Ù†";
        } else {
            db.inventory.push({ id: Date.now(), name: n, qty: q, min: m, buy: b, sell: s });
        }
        ['inv-n','inv-q','inv-m','inv-buy','inv-sell'].forEach(f => document.getElementById(f).value = '');
        save();
    }

    function editInv(id) {
        const i = db.inventory.find(x => x.id == id);
        document.getElementById('inv-edit-id').value = i.id;
        document.getElementById('inv-n').value = i.name; document.getElementById('inv-q').value = i.qty;
        document.getElementById('inv-m').value = i.min; document.getElementById('inv-buy').value = i.buy;
        document.getElementById('inv-sell').value = i.sell; document.getElementById('inv-btn').innerText = "ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¢Ù†";
    }

    function saveExpense() {
        const id = document.getElementById('exp-edit-id').value;
        const n = document.getElementById('exp-n').value, a = parseFloat(document.getElementById('exp-a').value);
        if(!n || a <= 0) return;
        if(id) {
            const idx = db.expenses.findIndex(e => e.id == id);
            db.expenses[idx] = { id: parseInt(id), name: n, amt: a };
            document.getElementById('exp-edit-id').value = "";
            document.getElementById('exp-btn').innerText = "Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ";
        } else {
            db.expenses.push({ id: Date.now(), name: n, amt: a });
        }
        document.getElementById('exp-n').value = ""; document.getElementById('exp-a').value = "";
        save();
    }

    function editExp(id) {
        const e = db.expenses.find(x => x.id == id);
        document.getElementById('exp-edit-id').value = e.id;
        document.getElementById('exp-n').value = e.name;
        document.getElementById('exp-a').value = e.amt;
        document.getElementById('exp-btn').innerText = "ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØµØ±ÙˆÙ";
    }

    function renderInventory(f = "") {
        document.getElementById('inventory-body').innerHTML = db.inventory.filter(i => i.name.includes(f)).map(i => `
            <tr>
                <td>${i.name}</td><td>${i.qty}</td><td>${i.buy}</td><td>${i.sell}</td>
                <td style="font-weight:bold">${(i.qty * i.buy).toFixed(2)}</td>
                <td>
                    <button class="btn btn-warning" style="display:inline; padding:5px" onclick="editInv(${i.id})">ØªØ¹Ø¯ÙŠÙ„</button>
                    <button class="btn btn-danger" style="display:inline; padding:5px" onclick="if(confirm('Ø­Ø°ÙØŸ')){db.inventory=db.inventory.filter(x=>x.id!=${i.id});save();}">Ø­Ø°Ù</button>
                </td>
            </tr>`).join('');
    }

    function renderAll() {
        const tTotal = db.today.reduce((s,i)=>s+i.totalPrice, 0);
        const eTotal = db.expenses.reduce((s,i)=>s+i.amt, 0);
        const invTotalVal = db.inventory.reduce((s,i)=>s+(i.qty * i.buy), 0);

        document.getElementById('stat-today').innerText = tTotal.toFixed(2);
        document.getElementById('stat-exp').innerText = eTotal.toFixed(2);
        document.getElementById('stat-profit').innerText = (tTotal - eTotal).toFixed(2);
        document.getElementById('stat-inv-val').innerText = invTotalVal.toFixed(2);

        document.getElementById('today-sales-body').innerHTML = db.today.map(i => `
            <tr>
                <td>${i.time}</td><td>${i.name}</td><td>${i.qty}</td><td>${i.unitPrice}</td>
                <td style="font-weight:bold; color:var(--primary)">${i.totalPrice.toFixed(2)}</td>
                <td>
                    <button class="btn btn-warning" style="display:inline; padding:5px" onclick="editSale(${i.id})"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-danger" style="display:inline; padding:5px" onclick="deleteSale(${i.id})"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`).join('');

        document.getElementById('expense-body').innerHTML = db.expenses.map(e => `
            <tr><td>${e.name}</td><td>${e.amt}</td><td><button class="btn btn-warning" onclick="editExp(${e.id})">ØªØ¹Ø¯ÙŠÙ„</button></td></tr>
        `).join('');
        
        const low = db.inventory.filter(i => i.qty <= i.min);
        document.getElementById('auto-low-body').innerHTML = low.map(i => `<tr><td>${i.name}</td><td><button class="btn btn-success" onclick="toggleShop(${i.id})">Ù†Ù‚Ù„</button></td></tr>`).join('');
        const fin = db.inventory.filter(i => db.shopping.includes(i.id));
        document.getElementById('final-shop-body').innerHTML = fin.map(i => `<tr><td>${i.name}</td><td>âœ…</td><td><button onclick="toggleShop(${i.id})">X</button></td></tr>`).join('');
        
        renderInventory(document.getElementById('inv-search-input')?.value || "");
    }

    function toggleShop(id) {
        const idx = db.shopping.indexOf(id);
        if(idx === -1) db.shopping.push(id); else db.shopping.splice(idx, 1);
        save();
    }

    window.onload = () => {
        if(localStorage.getItem('darkV13') === 'true') document.body.classList.add('dark-mode');
        renderAll();
    };
</script>
</body>
</html>