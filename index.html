<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة المخزن والموردين</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --success-color: #4cc9f0;
            --danger-color: #f72585;
            --warning-color: #f8961e;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --bg-color: #f0f2f5;
            --text-color: #333;
            --card-bg: white;
            --border-color: #ddd;
            --table-hover: #f8f9fa;
            --th-bg: #4361ee;
            --th-color: white;
        }

        .dark-mode {
            --bg-color: #121212;
            --text-color: #e0e0e0;
            --card-bg: #1e1e1e;
            --border-color: #333;
            --table-hover: #2d2d2d;
            --th-bg: #3a3a3a;
            --th-color: #e0e0e0;
            --light-color: #2d2d2d;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            transition: background-color 0.3s, color 0.3s;
        }
        
        body {
            font-family: 'Tajawal', Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 20px;
            direction: rtl;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 30px;
            font-size: 28px;
            position: relative;
            padding-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        h1::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 50%;
            transform: translateX(50%);
            width: 100px;
            height: 3px;
            background-color: var(--success-color);
        }
        
        .toggle-dark-mode {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 20px;
            cursor: pointer;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            border-bottom: 3px solid var(--primary-color);
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .input-section {
            background-color: var(--light-color);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .input-field {
            display: flex;
            flex-direction: column;
        }
        
        .input-field label {
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--text-color);
        }
        
        .input-field input, 
        .input-field select,
        .input-field textarea {
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            background-color: var(--card-bg);
            color: var(--text-color);
        }
        
        .input-field input:focus, 
        .input-field select:focus,
        .input-field textarea:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #d1146a;
            transform: translateY(-2px);
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #e07e0c;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #3ab4d9;
            transform: translateY(-2px);
        }
        
        .btn-info {
            background-color: #4895ef;
            color: white;
        }
        
        .btn-info:hover {
            background-color: #3a7bc8;
            transform: translateY(-2px);
        }
        
        .search-box {
            margin-bottom: 25px;
            position: relative;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 20px 12px 45px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            font-size: 16px;
            background-color: var(--card-bg);
            color: var(--text-color);
        }
        
        .search-box i {
            position: absolute;
            top: 50%;
            right: 15px;
            transform: translateY(-50%);
            color: #777;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: var(--card-bg);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        th, td {
            padding: 15px;
            text-align: right;
            border-bottom: 1px solid var(--border-color);
        }
        
        th {
            background-color: var(--th-bg);
            color: var(--th-color);
            font-weight: bold;
            position: sticky;
            top: 0;
        }
        
        tr:hover {
            background-color: var(--table-hover);
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .action-buttons button {
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .total-section {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--light-color);
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            font-size: 18px;
        }
        
        .total-amount {
            color: var(--primary-color);
            font-size: 20px;
        }
        
        .no-products {
            text-align: center;
            padding: 30px;
            color: #777;
        }
        
        .back-btn {
            margin-top: 30px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: bold;
        }

        .supplier-info {
            background-color: var(--light-color);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .supplier-info h3 {
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .drag-drop-area {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-bottom: 15px;
            cursor: pointer;
        }

        .drag-drop-area:hover {
            border-color: var(--primary-color);
        }

        .drag-drop-area i {
            font-size: 40px;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .product-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-content {
            background-color: var(--card-bg);
            margin: 50px auto;
            padding: 30px;
            border-radius: 10px;
            max-width: 800px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            left: 15px;
            font-size: 24px;
            cursor: pointer;
            color: var(--danger-color);
        }

        .invoice-products {
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .input-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            th, td {
                padding: 10px 5px;
                font-size: 14px;
            }

            .tabs {
                overflow-x: auto;
                white-space: nowrap;
                padding-bottom: 5px;
            }

            .modal-content {
                margin: 20px;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            <span><i class="fas fa-warehouse"></i> نظام إدارة المخزن والموردين</span>
            <button class="toggle-dark-mode" id="toggleDarkMode">
                <i class="fas fa-moon"></i>
            </button>
        </h1>

        <div class="tabs">
            <div class="tab active" data-tab="products">المنتجات</div>
            <div class="tab" data-tab="suppliers">الموردين</div>
            <div class="tab" data-tab="invoices">سجل الفواتير</div>
        </div>

        <!-- منتجات المخزن -->
        <div class="tab-content active" id="products-tab">
            <div class="input-section">
                <div class="input-grid">
                    <div class="input-field">
                        <label for="productName">اسم المنتج</label>
                        <input type="text" id="productName" placeholder="أدخل اسم المنتج">
                    </div>
                    <div class="input-field">
                        <label for="productQuantity">الكمية</label>
                        <input type="number" id="productQuantity" placeholder="الكمية" min="1" value="1">
                    </div>
                    <div class="input-field">
                        <label for="unitPrice">السعر الإفرادي (دينار)</label>
                        <input type="number" id="unitPrice" placeholder="السعر للوحدة" min="0" step="0.01">
                    </div>
                    <div class="input-field">
                        <label for="salePrice">سعر البيع (دينار)</label>
                        <input type="number" id="salePrice" placeholder="سعر البيع" min="0" step="0.01">
                    </div>
                    <div class="input-field">
                        <label for="totalPrice">السعر الإجمالي (دينار)</label>
                        <input type="number" id="totalPrice" placeholder="السعر الإجمالي" min="0" step="0.01" readonly>
                    </div>
                    <div class="input-field">
                        <label for="productSupplier">المورد</label>
                        <input type="text" id="productSupplier" placeholder="اسم المورد">
                    </div>
                </div>

                <div class="drag-drop-area" id="dropArea">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <p>اسحب وأفلت صورة المنتج هنا أو انقر لاختيار صورة</p>
                    <input type="file" id="productImage" accept="image/*" style="display: none;">
                </div>

                <div class="input-field">
                    <label for="productNotes">ملاحظات</label>
                    <textarea id="productNotes" rows="2" placeholder="أي ملاحظات إضافية عن المنتج"></textarea>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="addProduct()">
                        <i class="fas fa-plus"></i> إضافة منتج
                    </button>
                    <button class="btn btn-success" onclick="saveToInvoices()">
                        <i class="fas fa-save"></i> حفظ إلى سجل الفواتير
                    </button>
                    <button class="btn btn-info" onclick="clearForm()">
                        <i class="fas fa-broom"></i> مسح النموذج
                    </button>
                </div>
            </div>

            <div class="search-box">
                <input type="text" id="searchInput" placeholder="ابحث عن منتج..." oninput="renderInventory()">
                <i class="fas fa-search"></i>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>الصورة</th>
                        <th>اسم المنتج</th>
                        <th>الكمية</th>
                        <th>السعر الإفرادي</th>
                        <th>السعر الإجمالي</th>
                        <th>سعر البيع</th>
                        <th>المورد</th>
                        <th>الإجراءات</th>
                    </tr>
                </thead>
                <tbody id="inventoryBody"></tbody>
            </table>

            <div class="total-section">
                <span>المجموع الكلي:</span>
                <span class="total-amount" id="totalAmount">0.00 دينار</span>
            </div>
        </div>

        <!-- إدارة الموردين -->
        <div class="tab-content" id="suppliers-tab">
            <div class="input-section">
                <h3 style="margin-bottom: 15px; color: var(--primary-color);">إضافة مورد جديد</h3>
                <div class="input-grid">
                    <div class="input-field">
                        <label for="supplierName">اسم المورد</label>
                        <input type="text" id="supplierName" placeholder="اسم المورد أو الشركة">
                    </div>
                    <div class="input-field">
                        <label for="supplierPhone">رقم الهاتف</label>
                        <input type="tel" id="supplierPhone" placeholder="رقم التواصل">
                    </div>
                    <div class="input-field">
                        <label for="supplierEmail">البريد الإلكتروني</label>
                        <input type="email" id="supplierEmail" placeholder="البريد الإلكتروني">
                    </div>
                    <div class="input-field">
                        <label for="supplierAddress">العنوان</label>
                        <input type="text" id="supplierAddress" placeholder="عنوان المورد">
                    </div>
                </div>

                <div class="input-field">
                    <label for="supplierNotes">ملاحظات</label>
                    <textarea id="supplierNotes" rows="2" placeholder="أي ملاحظات إضافية عن المورد"></textarea>
                </div>

                <button class="btn btn-primary" onclick="addSupplier()">
                    <i class="fas fa-plus"></i> إضافة مورد
                </button>
            </div>

            <div class="search-box">
                <input type="text" id="searchSupplierInput" placeholder="ابحث عن مورد..." oninput="renderSuppliers()">
                <i class="fas fa-search"></i>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>اسم المورد</th>
                        <th>رقم الهاتف</th>
                        <th>البريد الإلكتروني</th>
                        <th>العنوان</th>
                        <th>المنتجات الموردة</th>
                        <th>الإجراءات</th>
                    </tr>
                </thead>
                <tbody id="suppliersBody"></tbody>
            </table>
        </div>

        <!-- سجل الفواتير -->
        <div class="tab-content" id="invoices-tab">
            <div class="search-box">
                <input type="text" id="searchInvoiceInput" placeholder="ابحث في سجل الفواتير..." oninput="renderInvoices()">
                <i class="fas fa-search"></i>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>رقم الفاتورة</th>
                        <th>التاريخ</th>
                        <th>عدد المنتجات</th>
                        <th>المجموع الكلي</th>
                        <th>الإجراءات</th>
                    </tr>
                </thead>
                <tbody id="invoicesBody"></tbody>
            </table>
        </div>
    </div>

    <!-- Modal لعرض الفاتورة -->
    <div class="modal" id="invoiceModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <div id="invoiceModalContent"></div>
        </div>
    </div>

    <!-- Modal لتعديل الفاتورة -->
    <div class="modal" id="editInvoiceModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeEditModal()">&times;</span>
            <div id="editInvoiceModalContent"></div>
        </div>
    </div>

    <script>
        // بيانات التطبيق
        let inventory = JSON.parse(localStorage.getItem('inventory')) || [];
        let suppliers = JSON.parse(localStorage.getItem('suppliers')) || [];
        let invoices = JSON.parse(localStorage.getItem('invoices')) || [];
        let editIndex = -1;
        let currentProductImage = null;
        let darkMode = localStorage.getItem('darkMode') === 'true';
        let currentEditingInvoiceIndex = -1;

        // تهيئة الوضع المظلم
        function initDarkMode() {
            if (darkMode) {
                document.body.classList.add('dark-mode');
                document.getElementById('toggleDarkMode').innerHTML = '<i class="fas fa-sun"></i>';
            }
        }

        // تبديل الوضع المظلم
        function toggleDarkMode() {
            darkMode = !darkMode;
            localStorage.setItem('darkMode', darkMode);
            
            if (darkMode) {
                document.body.classList.add('dark-mode');
                document.getElementById('toggleDarkMode').innerHTML = '<i class="fas fa-sun"></i>';
            } else {
                document.body.classList.remove('dark-mode');
                document.getElementById('toggleDarkMode').innerHTML = '<i class="fas fa-moon"></i>';
            }
        }

        // تبديل التبويبات
        function setupTabs() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // إزالة النشاط من جميع التبويبات
                    tabs.forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // إضافة النشاط للتبويب المحدد
                    tab.classList.add('active');
                    document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
                });
            });
        }

        // حساب السعر الإجمالي تلقائياً
        function setupAutoCalculate() {
            document.getElementById('productQuantity').addEventListener('input', calculateTotalPrice);
            document.getElementById('unitPrice').addEventListener('input', calculateTotalPrice);
        }

        function calculateTotalPrice() {
            const quantity = parseFloat(document.getElementById('productQuantity').value) || 0;
            const unitPrice = parseFloat(document.getElementById('unitPrice').value) || 0;
            const totalPrice = quantity * unitPrice;
            document.getElementById('totalPrice').value = totalPrice.toFixed(2);
        }

        // سحب وإفلات الصور
        function setupDragAndDrop() {
            const dropArea = document.getElementById('dropArea');
            const fileInput = document.getElementById('productImage');

            dropArea.addEventListener('click', () => fileInput.click());

            fileInput.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    handleImage(this.files[0]);
                }
            });

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });

            function highlight() {
                dropArea.style.borderColor = 'var(--primary-color)';
                dropArea.style.backgroundColor = 'rgba(67, 97, 238, 0.1)';
            }

            function unhighlight() {
                dropArea.style.borderColor = 'var(--border-color)';
                dropArea.style.backgroundColor = 'transparent';
            }

            dropArea.addEventListener('drop', handleDrop, false);

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;

                if (files && files[0]) {
                    handleImage(files[0]);
                }
            }
        }

        function handleImage(file) {
            const reader = new FileReader();
            
            reader.onload = function(event) {
                currentProductImage = event.target.result;
                document.getElementById('dropArea').innerHTML = `
                    <img src="${event.target.result}" style="max-width: 100px; max-height: 100px; border-radius: 4px;">
                    <p style="margin-top: 10px;">تم تحميل الصورة بنجاح</p>
                `;
            };
            
            reader.readAsDataURL(file);
        }

        // عرض المنتجات
        function renderInventory() {
            const body = document.getElementById('inventoryBody');
            const search = document.getElementById('searchInput').value.toLowerCase();
            body.innerHTML = '';

            let filtered = inventory.filter(p => 
                p.name.toLowerCase().includes(search) || 
                (p.supplier && p.supplier.toLowerCase().includes(search))
            );

            if (filtered.length === 0) {
                body.innerHTML = '<tr><td colspan="8" class="no-products">لا توجد منتجات في المخزن</td></tr>';
                updateTotalAmount();
                return;
            }

            filtered.forEach((product, index) => {
                const row = document.createElement('tr');
                const totalPrice = product.quantity * product.unitPrice;
                
                row.innerHTML = `
                    <td>
                        ${product.image ? 
                            `<img src="${product.image}" class="product-image" alt="${product.name}">` : 
                            '<i class="fas fa-box-open" style="font-size: 24px; color: #777;"></i>'}
                    </td>
                    <td>${product.name}</td>
                    <td>${product.quantity}</td>
                    <td>${product.unitPrice.toFixed(2)} دينار</td>
                    <td>${totalPrice.toFixed(2)} دينار</td>
                    <td>${product.salePrice ? product.salePrice.toFixed(2) + " دينار" : "-"}</td>
                    <td>${product.supplier || 'غير محدد'}</td>
                    <td class="action-buttons">
                        <button class="btn btn-warning" onclick="editProduct(${index})">
                            <i class="fas fa-edit"></i> تعديل
                        </button>
                        <button class="btn btn-danger" onclick="deleteProduct(${index})">
                            <i class="fas fa-trash"></i> حذف
                        </button>
                    </td>
                `;
                body.appendChild(row);
            });

            updateTotalAmount();
        }

        function updateTotalAmount() {
            const total = inventory.reduce((sum, product) => {
                return sum + (product.quantity * product.unitPrice);
            }, 0);
            
            document.getElementById('totalAmount').textContent = total.toFixed(2) + ' دينار';
        }

        // إضافة/تعديل منتج
        function addProduct() {
            const name = document.getElementById('productName').value.trim();
            const quantity = parseFloat(document.getElementById('productQuantity').value);
            const unitPrice = parseFloat(document.getElementById('unitPrice').value);
            const supplier = document.getElementById('productSupplier').value.trim();
            const salePrice = parseFloat(document.getElementById('salePrice').value);
            const notes = document.getElementById('productNotes').value.trim();

            if (!name || isNaN(quantity) || isNaN(unitPrice) || quantity <= 0 || unitPrice <= 0) {
                alert('يرجى إدخال كافة البيانات بشكل صحيح');
                return;
            }

            const product = {
                name,
                salePrice,
                quantity,
                unitPrice,
                supplier,
                notes,
                image: currentProductImage,
                date: new Date().toISOString()
            };

            if (editIndex === -1) {
                // Add new product
                inventory.push(product);
            } else {
                // Update existing product
                inventory[editIndex] = product;
                editIndex = -1;
                document.querySelector('.btn-primary').innerHTML = '<i class="fas fa-plus"></i> إضافة منتج';
            }

            saveData();
            renderInventory();
            clearForm();
        }

        function editProduct(index) {
            const product = inventory[index];
            document.getElementById('productName').value = product.name;
            document.getElementById('productQuantity').value = product.quantity;
            document.getElementById('unitPrice').value = product.unitPrice;
            document.getElementById('productSupplier').value = product.supplier || '';
            document.getElementById('salePrice').value = product.salePrice || '';
            document.getElementById('productNotes').value = product.notes || '';
            calculateTotalPrice();
            
            if (product.image) {
                currentProductImage = product.image;
                document.getElementById('dropArea').innerHTML = `
                    <img src="${product.image}" style="max-width: 100px; max-height: 100px; border-radius: 4px;">
                    <p style="margin-top: 10px;">صورة المنتج الحالية</p>
                `;
            } else {
                currentProductImage = null;
                document.getElementById('dropArea').innerHTML = `
                    <i class="fas fa-cloud-upload-alt"></i>
                    <p>اسحب وأفلت صورة المنتج هنا أو انقر لاختيار صورة</p>
                    <input type="file" id="productImage" accept="image/*" style="display: none;">
                `;
            }
            
            editIndex = index;
            document.querySelector('.btn-primary').innerHTML = '<i class="fas fa-save"></i> حفظ التعديلات';
            
            // Scroll to form
            document.getElementById('productName').focus();
        }

        function deleteProduct(index) {
            if (confirm('هل أنت متأكد من حذف هذا المنتج؟')) {
                inventory.splice(index, 1);
                saveData();
                renderInventory();
                
                if (editIndex === index) {
                    editIndex = -1;
                    clearForm();
                    document.querySelector('.btn-primary').innerHTML = '<i class="fas fa-plus"></i> إضافة منتج';
                }
            }
        }

        function clearForm() {
            document.getElementById('productName').value = '';
            document.getElementById('productQuantity').value = '1';
            document.getElementById('unitPrice').value = '';
            document.getElementById('totalPrice').value = '';
            document.getElementById('productSupplier').value = '';
            document.getElementById('salePrice').value = '';
            document.getElementById('productNotes').value = '';
            currentProductImage = null;
            document.getElementById('dropArea').innerHTML = `
                <i class="fas fa-cloud-upload-alt"></i>
                <p>اسحب وأفلت صورة المنتج هنا أو انقر لاختيار صورة</p>
                <input type="file" id="productImage" accept="image/*" style="display: none;">
            `;
            document.getElementById('productName').focus();
        }

        // إدارة الموردين
        function renderSuppliers() {
            const body = document.getElementById('suppliersBody');
            const search = document.getElementById('searchSupplierInput').value.toLowerCase();
            body.innerHTML = '';

            let filtered = suppliers.filter(s => 
                s.name.toLowerCase().includes(search) || 
                (s.phone && s.phone.includes(search)) ||
                (s.email && s.email.toLowerCase().includes(search))
            );

            if (filtered.length === 0) {
                body.innerHTML = '<tr><td colspan="6" class="no-products">لا توجد موردين مسجلين</td></tr>';
                return;
            }

            filtered.forEach((supplier, index) => {
                const productsCount = inventory.filter(p => p.supplier === supplier.name).length;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${supplier.name}</td>
                    <td>${supplier.phone || '-'}</td>
                    <td>${supplier.email || '-'}</td>
                    <td>${supplier.address || '-'}</td>
                    <td>${productsCount} منتج</td>
                    <td class="action-buttons">
                        <button class="btn btn-danger" onclick="deleteSupplier(${index})">
                            <i class="fas fa-trash"></i> حذف
                        </button>
                    </td>
                `;
                body.appendChild(row);
            });
        }

        function addSupplier() {
            const name = document.getElementById('supplierName').value.trim();
            const phone = document.getElementById('supplierPhone').value.trim();
            const email = document.getElementById('supplierEmail').value.trim();
            const address = document.getElementById('supplierAddress').value.trim();
            const notes = document.getElementById('supplierNotes').value.trim();

            if (!name) {
                alert('يرجى إدخال اسم المورد');
                return;
            }

            suppliers.push({
                name,
                phone,
                email,
                address,
                notes,
                date: new Date().toISOString()
            });

            saveData();
            renderSuppliers();
            
            // Clear form
            document.getElementById('supplierName').value = '';
            document.getElementById('supplierPhone').value = '';
            document.getElementById('supplierEmail').value = '';
            document.getElementById('supplierAddress').value = '';
            document.getElementById('supplierNotes').value = '';
        }

        function deleteSupplier(index) {
            if (confirm('هل أنت متأكد من حذف هذا المورد؟ سيتم إزالة ارتباطه بجميع المنتجات.')) {
                const supplierName = suppliers[index].name;
                
                // إزالة اسم المورد من المنتجات المرتبطة به
                inventory.forEach(product => {
                    if (product.supplier === supplierName) {
                        product.supplier = '';
                    }
                });
                
                suppliers.splice(index, 1);
                saveData();
                renderSuppliers();
                renderInventory();
            }
        }

        // سجل الفواتير
        function saveToInvoices() {
            if (inventory.length === 0) {
                alert('لا توجد منتجات لحفظها في سجل الفواتير');
                return;
            }

            const invoice = {
                id: 'INV-' + Date.now(),
                date: new Date().toLocaleString('ar-EG'),
                products: [...inventory],
                total: inventory.reduce((sum, product) => sum + (product.quantity * product.unitPrice), 0)
            };

            invoices.unshift(invoice); // إضافة في الأعلى
            saveData();
            renderInvoices();
            
            // إظهار تبويب الفواتير
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector('.tab[data-tab="invoices"]').classList.add('active');
            document.getElementById('invoices-tab').classList.add('active');
            
            alert('تم حفظ الفاتورة بنجاح في السجل');
        }

        function renderInvoices() {
            const body = document.getElementById('invoicesBody');
            const search = document.getElementById('searchInvoiceInput').value.toLowerCase();
            body.innerHTML = '';

            let filtered = invoices.filter(inv => 
                inv.id.toLowerCase().includes(search) || 
                inv.date.toLowerCase().includes(search)
            );

            if (filtered.length === 0) {
                body.innerHTML = '<tr><td colspan="5" class="no-products">لا توجد فواتير مسجلة</td></tr>';
                return;
            }

            filtered.forEach((invoice, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${invoice.id}</td>
                    <td>${invoice.date}</td>
                    <td>${invoice.products.length}</td>
                    <td>${invoice.total.toFixed(2)} دينار</td>
                    <td class="action-buttons">
                        <button class="btn btn-info" onclick="viewInvoice(${index})">
                            <i class="fas fa-eye"></i> عرض
                        </button>
                        <button class="btn btn-warning" onclick="editInvoice(${index})">
                            <i class="fas fa-edit"></i> تعديل
                        </button>
                        <button class="btn btn-danger" onclick="deleteInvoice(${index})">
                            <i class="fas fa-trash"></i> حذف
                        </button>
                    </td>
                `;
                body.appendChild(row);
            });
        }

        function viewInvoice(index) {
            const invoice = invoices[index];
            let productsList = '';
            
            invoice.products.forEach(product => {
                productsList += `
                    <tr>
                        <td>${product.name}</td>
                        <td>${product.quantity}</td>
                        <td>${product.unitPrice.toFixed(2)} دينار</td>
                        <td>${(product.quantity * product.unitPrice).toFixed(2)} دينار</td>
                    </tr>
                `;
            });
            
            const invoiceDetails = `
                <h2 style="color: var(--primary-color); text-align: center; margin-bottom: 20px;">فاتورة #${invoice.id}</h2>
                <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                    <div>
                        <p><strong>التاريخ:</strong> ${invoice.date}</p>
                        <p><strong>عدد المنتجات:</strong> ${invoice.products.length}</p>
                    </div>
                    <div style="background-color: var(--light-color); padding: 15px; border-radius: 8px;">
                        <p style="font-size: 18px; font-weight: bold;">المجموع الكلي: <span style="color: var(--primary-color);">${invoice.total.toFixed(2)} دينار</span></p>
                    </div>
                </div>
                
                <h3 style="color: var(--primary-color); margin-bottom: 15px;">تفاصيل المنتجات:</h3>
                <div class="invoice-products">
                    <table style="width: 100%;">
                        <thead>
                            <tr>
                                <th>اسم المنتج</th>
                                <th>الكمية</th>
                                <th>السعر</th>
                                <th>الإجمالي</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${productsList}
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn btn-primary" onclick="printInvoice(${index})">
                        <i class="fas fa-print"></i> طباعة الفاتورة
                    </button>
                </div>
            `;
            
            document.getElementById('invoiceModalContent').innerHTML = invoiceDetails;
            document.getElementById('invoiceModal').style.display = 'block';
        }

        function editInvoice(index) {
            currentEditingInvoiceIndex = index;
            const invoice = invoices[index];
            
            let productsList = '';
            
            invoice.products.forEach((product, productIndex) => {
                productsList += `
                    <tr>
                        <td>${product.name}</td>
                        <td>${product.quantity}</td>
                        <td>${product.unitPrice.toFixed(2)} دينار</td>
                        <td>${(product.quantity * product.unitPrice).toFixed(2)} دينار</td>
                        <td>
                            <button class="btn btn-danger" onclick="removeProductFromInvoice(${productIndex})">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            const editForm = `
                <h2 style="color: var(--primary-color); text-align: center; margin-bottom: 20px;">تعديل فاتورة #${invoice.id}</h2>
                
                <div style="margin-bottom: 20px;">
                    <p><strong>التاريخ:</strong> ${invoice.date}</p>
                    <p><strong>عدد المنتجات:</strong> ${invoice.products.length}</p>
                    <p><strong>المجموع الكلي:</strong> ${invoice.total.toFixed(2)} دينار</p>
                </div>
                
                <h3 style="color: var(--primary-color); margin-bottom: 15px;">منتجات الفاتورة:</h3>
                <div class="invoice-products">
                    <table style="width: 100%;">
                        <thead>
                            <tr>
                                <th>اسم المنتج</th>
                                <th>الكمية</th>
                                <th>السعر</th>
                                <th>الإجمالي</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="invoiceProductsBody">
                            ${productsList}
                        </tbody>
                    </table>
                </div>
                
                <h3 style="color: var(--primary-color); margin-top: 30px; margin-bottom: 15px;">إضافة منتجات جديدة:</h3>
                <div class="input-grid" style="margin-bottom: 20px;">
                    <div class="input-field">
                        <label for="newProductName">اسم المنتج</label>
                        <input type="text" id="newProductName" placeholder="أدخل اسم المنتج">
                    </div>
                    <div class="input-field">
                        <label for="newProductQuantity">الكمية</label>
                        <input type="number" id="newProductQuantity" placeholder="الكمية" min="1" value="1">
                    </div>
                    <div class="input-field">
                        <label for="newUnitPrice">السعر الإفرادي (دينار)</label>
                        <input type="number" id="newUnitPrice" placeholder="السعر للوحدة" min="0" step="0.01">
                    </div>
                </div>
                
                <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="addProductToInvoice()">
                        <i class="fas fa-plus"></i> إضافة منتج للفاتورة
                    </button>
                    <button class="btn btn-success" onclick="saveEditedInvoice()">
                        <i class="fas fa-save"></i> حفظ التعديلات
                    </button>
                </div>
            `;
            
            document.getElementById('editInvoiceModalContent').innerHTML = editForm;
            document.getElementById('editInvoiceModal').style.display = 'block';
        }

        function addProductToInvoice() {
            const name = document.getElementById('newProductName').value.trim();
            const quantity = parseFloat(document.getElementById('newProductQuantity').value);
            const unitPrice = parseFloat(document.getElementById('newUnitPrice').value);

            if (!name || isNaN(quantity) || isNaN(unitPrice) || quantity <= 0 || unitPrice <= 0) {
                alert('يرجى إدخال كافة بيانات المنتج بشكل صحيح');
                return;
            }

            const product = {
                name,
                quantity,
                unitPrice,
                date: new Date().toISOString()
            };

            invoices[currentEditingInvoiceIndex].products.push(product);
            updateInvoiceTotal(currentEditingInvoiceIndex);
            renderInvoiceProducts();
            
            // Clear form
            document.getElementById('newProductName').value = '';
            document.getElementById('newProductQuantity').value = '1';
            document.getElementById('newUnitPrice').value = '';
        }

        function removeProductFromInvoice(productIndex) {
            if (confirm('هل أنت متأكد من حذف هذا المنتج من الفاتورة؟')) {
                invoices[currentEditingInvoiceIndex].products.splice(productIndex, 1);
                updateInvoiceTotal(currentEditingInvoiceIndex);
                renderInvoiceProducts();
            }
        }

        function renderInvoiceProducts() {
            const invoice = invoices[currentEditingInvoiceIndex];
            const body = document.getElementById('invoiceProductsBody');
            body.innerHTML = '';
            
            invoice.products.forEach((product, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${product.name}</td>
                    <td>${product.quantity}</td>
                    <td>${product.unitPrice.toFixed(2)} دينار</td>
                    <td>${(product.quantity * product.unitPrice).toFixed(2)} دينار</td>
                    <td>
                        <button class="btn btn-danger" onclick="removeProductFromInvoice(${index})">
                            <i class="fas fa-trash"></i> حذف
                        </button>
                    </td>
                `;
                body.appendChild(row);
            });
        }

        function updateInvoiceTotal(index) {
            invoices[index].total = invoices[index].products.reduce((sum, product) => {
                return sum + (product.quantity * product.unitPrice);
            }, 0);
        }

        function saveEditedInvoice() {
            saveData();
            renderInvoices();
            closeEditModal();
            alert('تم حفظ تعديلات الفاتورة بنجاح');
        }

        function deleteInvoice(index) {
            if (confirm('هل أنت متأكد من حذف هذه الفاتورة؟')) {
                invoices.splice(index, 1);
                saveData();
                renderInvoices();
            }
        }

        function printInvoice(index) {
            const invoice = invoices[index];
            let printContent = `
                <div style="font-family: Arial; padding: 20px; max-width: 800px; margin: 0 auto;">
                    <h1 style="text-align: center; color: #4361ee;">فاتورة #${invoice.id}</h1>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 30px;">
                        <div>
                            <p><strong>التاريخ:</strong> ${invoice.date}</p>
                        </div>
                        <div>
                            <p><strong>عدد المنتجات:</strong> ${invoice.products.length}</p>
                        </div>
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
                        <thead>
                            <tr style="background-color: #4361ee; color: white;">
                                <th style="padding: 10px; text-align: right;">اسم المنتج</th>
                                <th style="padding: 10px; text-align: right;">الكمية</th>
                                <th style="padding: 10px; text-align: right;">السعر</th>
                                <th style="padding: 10px; text-align: right;">الإجمالي</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            invoice.products.forEach(product => {
                printContent += `
                    <tr>
                        <td style="padding: 10px; border-bottom: 1px solid #ddd;">${product.name}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #ddd;">${product.quantity}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #ddd;">${product.unitPrice.toFixed(2)} دينار</td>
                        <td style="padding: 10px; border-bottom: 1px solid #ddd;">${(product.quantity * product.unitPrice).toFixed(2)} دينار</td>
                    </tr>
                `;
            });
            
            printContent += `
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" style="text-align: left; padding: 10px; font-weight: bold;">المجموع الكلي:</td>
                                <td style="padding: 10px; font-weight: bold;">${invoice.total.toFixed(2)} دينار</td>
                            </tr>
                        </tfoot>
                    </table>
                    
                    <div style="text-align: center; margin-top: 50px; font-size: 12px; color: #777;">
                        <p>شكراً لتعاملكم معنا</p>
                    </div>
                </div>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        }

        function closeModal() {
            document.getElementById('invoiceModal').style.display = 'none';
        }

        function closeEditModal() {
            document.getElementById('editInvoiceModal').style.display = 'none';
            currentEditingInvoiceIndex = -1;
        }

        // حفظ البيانات
        function saveData() {
            localStorage.setItem('inventory', JSON.stringify(inventory));
            localStorage.setItem('suppliers', JSON.stringify(suppliers));
            localStorage.setItem('invoices', JSON.stringify(invoices));
        }

        // تهيئة التطبيق
        function initApp() {
            initDarkMode();
            setupTabs();
            setupAutoCalculate();
            setupDragAndDrop();
            
            document.getElementById('toggleDarkMode').addEventListener('click', toggleDarkMode);
            
            renderInventory();
            renderSuppliers();
            renderInvoices();
            
            document.getElementById('productName').focus();
        }

        // تحميل التطبيق
        window.onload = initApp;
    </script>
</body>
</html>