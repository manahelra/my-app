<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²Ù† Ø§Ù„Ù…ØªØ·ÙˆØ±</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4361ee;
            --success-color: #2ec4b6;
            --danger-color: #e63946;
            --warning-color: #f8961e;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --bg-color: #f4f7fe;
            --text-color: #2b2d42;
            --card-bg: #ffffff;
            --border-color: #e0e0e0;
        }

        .dark-mode {
            --bg-color: #1a1a1a;
            --text-color: #f8f9fa;
            --card-bg: #2d2d2d;
            --border-color: #444;
            --light-color: #3d3d3d;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Tajawal', sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-color); padding: 20px; transition: 0.3s; }
        .container { max-width: 1400px; margin: 0 auto; background: var(--card-bg); padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }

        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        
        .tabs { display: flex; gap: 5px; border-bottom: 2px solid var(--border-color); margin-bottom: 20px; flex-wrap: wrap; }
        .tab { padding: 12px 15px; cursor: pointer; border-radius: 8px 8px 0 0; font-weight: bold; color: #888; transition: 0.3s; }
        .tab.active { background: var(--primary-color); color: white; }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }

        .search-bar { margin-bottom: 20px; position: relative; }
        .search-bar input { width: 100%; padding: 12px 40px 12px 12px; border-radius: 8px; border: 2px solid var(--primary-color); outline: none; }
        .search-bar i { position: absolute; right: 15px; top: 15px; color: var(--primary-color); }

        .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; background: var(--light-color); padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .input-field { display: flex; flex-direction: column; gap: 5px; }
        label { font-size: 0.9rem; font-weight: bold; }
        input, select, textarea { padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--card-bg); color: var(--text-color); }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: var(--card-bg); }
        th { background: var(--primary-color); color: white; padding: 12px; text-align: right; }
        td { padding: 12px; border-bottom: 1px solid var(--border-color); }
        
        .btn { padding: 8px 14px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; display: inline-flex; align-items: center; gap: 5px; font-size: 13px; }
        .btn-add { background: var(--primary-color); color: white; }
        .btn-market { background: var(--success-color); color: white; }
        .btn-danger { background: var(--danger-color); color: white; }
        .btn-edit { background: var(--warning-color); color: white; }
        .btn-info { background: #4895ef; color: white; }

        .badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; color: white; }
        .bg-buy { background: #5e60ce; }
        .bg-sell { background: #4ea8de; }
        .bg-total { background: #2a9d8f; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @media print { .no-print { display: none !important; } .container { box-shadow: none; width: 100%; } }
    </style>
</head>
<body>

<div class="container">
    <header class="no-print">
        <h1><i class="fas fa-store"></i> Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø·ÙˆØ±</h1>
        <button onclick="toggleTheme()" class="btn btn-info" id="themeIcon"><i class="fas fa-moon"></i></button>
    </header>

    <div class="tabs no-print">
        <div class="tab active" onclick="showTab('inventory')">ğŸ“¦ Ø§Ù„Ù…Ø®Ø²Ù†</div>
        <div class="tab" onclick="showTab('market')">ğŸ›’ Ø§Ù„Ø³ÙˆÙ‚</div>
        <div class="tab" onclick="showTab('history')">ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</div>
        <div class="tab" onclick="showTab('suppliers')">ğŸ¤ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</div>
    </div>

    <div class="search-bar no-print">
        <i class="fas fa-search"></i>
        <input type="text" id="globalSearch" placeholder="Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ..." onkeyup="filterTables()">
    </div>

    <div id="inventory-tab" class="tab-content active">
        <div class="input-grid no-print">
            <div class="input-field"><label>Ø§Ù„Ù…Ù†ØªØ¬</label><input type="text" id="p-name"></div>
            <div class="input-field"><label>Ø§Ù„ÙƒÙ…ÙŠØ©</label><input type="number" id="p-qty" value="1"></div>
            <div class="input-field"><label>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</label><input type="number" id="p-buy"></div>
            <div class="input-field"><label>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</label><input type="number" id="p-sell"></div>
            <div class="input-field"><label>Ø§Ù„Ù…ÙˆØ±Ø¯</label><select id="p-sup"></select></div>
            <div class="input-field" style="justify-content: flex-end;">
                <button class="btn btn-add" onclick="addToInventory()"><i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ©</button>
            </div>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                    <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                    <th>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th>
                    <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø´Ø±Ø§Ø¡)</th>
                    <th>Ø¨ÙŠØ¹ Ø§Ù„ÙØ±Ø§Ø¯ÙŠ</th>
                    <th>Ø§Ù„Ù…ÙˆØ±Ø¯</th>
                    <th class="no-print">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
            </thead>
            <tbody id="inventory-list"></tbody>
        </table>
    </div>

    <div id="market-tab" class="tab-content">
        <div class="input-grid no-print">
            <div class="input-field"><label>Ø§Ù„Ù…Ø§Ø¯Ø©</label><input type="text" id="m-item"></div>
            <div class="input-field"><label>Ø§Ù„ÙƒÙ…ÙŠØ©</label><input type="number" id="m-qty" value="1"></div>
            <div class="input-field"><label>Ø³Ø¹Ø± Ø§Ù„Ù‚Ø·Ø¹Ø©</label><input type="number" id="m-price"></div>
            <div class="input-field"><label>Ø§Ù„Ù…ÙƒØ§Ù†</label><input type="text" id="m-place"></div>
            <div class="input-field" style="justify-content: flex-end; flex-direction: row; gap: 5px;">
                <button class="btn btn-market" onclick="addToMarket()"><i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø¬Ø¯ÙˆÙ„</button>
                <button class="btn btn-info" onclick="saveMarketInvoice()"><i class="fas fa-save"></i> Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„</button>
            </div>
        </div>
        <table id="market-table">
            <thead>
                <tr>
                    <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                    <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                    <th>Ø³Ø¹Ø± Ø§Ù„Ù‚Ø·Ø¹Ø©</th>
                    <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                    <th>Ø§Ù„Ù…ÙƒØ§Ù†</th>
                    <th class="no-print">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
            </thead>
            <tbody id="market-list"></tbody>
        </table>
    </div>

    <div id="history-tab" class="tab-content">
        <h3>Ø³Ø¬Ù„ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</h3>
        <br>
        <table>
            <thead>
                <tr>
                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª</th>
                    <th>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯</th>
                    <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº</th>
                    <th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
                    <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
            </thead>
            <tbody id="history-list"></tbody>
        </table>
    </div>

    <div id="suppliers-tab" class="tab-content">
        <div class="input-grid no-print">
            <div class="input-field"><label>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯</label><input type="text" id="s-name"></div>
            <div class="input-field"><label>Ø§Ù„Ù‡Ø§ØªÙ</label><input type="text" id="s-phone"></div>
            <button class="btn btn-add" onclick="addSupplier()" style="margin-top: 25px;">Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ±Ø¯</button>
        </div>
        <table id="suppliers-table">
            <thead><tr><th>Ø§Ù„Ù…ÙˆØ±Ø¯</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø­Ø°Ù</th></tr></thead>
            <tbody id="suppliers-list"></tbody>
        </table>
    </div>
</div>

<script>
    let db = {
        inventory: JSON.parse(localStorage.getItem('inv_db_v2')) || [],
        market: JSON.parse(localStorage.getItem('market_db_v2')) || [],
        history: JSON.parse(localStorage.getItem('history_db_v2')) || [],
        suppliers: JSON.parse(localStorage.getItem('sup_db_v2')) || []
    };

    function showTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(tabId + '-tab').classList.add('active');
        event.currentTarget.classList.add('active');
        document.getElementById('globalSearch').value = '';
        filterTables();
    }

    function filterTables() {
        const searchValue = document.getElementById('globalSearch').value.toLowerCase();
        const activeTab = document.querySelector('.tab-content.active');
        const rows = activeTab.querySelectorAll('tbody tr');
        rows.forEach(row => {
            const text = row.innerText.toLowerCase();
            row.style.display = text.includes(searchValue) ? '' : 'none';
        });
    }

    // --- Ø§Ù„Ù…Ø®Ø²Ù† (ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶) ---
    function addToInventory() {
        const name = document.getElementById('p-name').value;
        const qty = parseFloat(document.getElementById('p-qty').value) || 0;
        const buy = parseFloat(document.getElementById('p-buy').value) || 0;
        const sell = parseFloat(document.getElementById('p-sell').value) || 0;
        const sup = document.getElementById('p-sup').value;

        if(!name || !buy || !sell) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©");

        db.inventory.push({ name, qty, buy, sell, sup, id: Date.now() });
        saveAndRender();
        ['p-name', 'p-qty', 'p-buy', 'p-sell'].forEach(id => document.getElementById(id).value = '');
    }

    function renderInventory() {
        const list = document.getElementById('inventory-list');
        list.innerHTML = db.inventory.map((p, i) => `
            <tr>
                <td><b>${p.name}</b></td>
                <td>${p.qty}</td>
                <td><span class="badge bg-buy">${p.buy}</span></td>
                <td><span class="badge bg-total">${(p.qty * p.buy).toFixed(2)}</span></td>
                <td><span class="badge bg-sell">${p.sell}</span></td>
                <td>${p.sup || 'Ø¹Ø§Ù…'}</td>
                <td class="no-print">
                    <button class="btn btn-edit" onclick="editInventory(${i})" title="ØªØ¹Ø¯ÙŠÙ„"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-danger" onclick="deleteItem('inventory', ${i})" title="Ø­Ø°Ù"><i class="fas fa-trash"></i></button>
                </td>
            </tr>
        `).join('');
    }

    // --- Ø§Ù„Ø³ÙˆÙ‚ (ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„Ø­Ø³Ø§Ø¨) ---
    function addToMarket() {
        const item = document.getElementById('m-item').value;
        const qty = parseFloat(document.getElementById('m-qty').value) || 1;
        const price = parseFloat(document.getElementById('m-price').value) || 0;
        const place = document.getElementById('m-place').value;

        if(!item || !price) return alert("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© ÙˆØ§Ù„Ø³Ø¹Ø±");

        db.market.push({ item, qty, price, place, id: Date.now() });
        saveAndRender();
        ['m-item', 'm-qty', 'm-price', 'm-place'].forEach(id => document.getElementById(id).value = '');
    }

    function renderMarket() {
        const list = document.getElementById('market-list');
        list.innerHTML = db.market.map((m, i) => `
            <tr>
                <td>${m.item}</td>
                <td>${m.qty}</td>
                <td>${m.price}</td>
                <td style="font-weight:bold; color:var(--primary-color);">${(m.qty * m.price).toFixed(2)}</td>
                <td>${m.place}</td>
                <td class="no-print">
                    <button class="btn btn-edit" onclick="editMarket(${i})" title="ØªØ¹Ø¯ÙŠÙ„"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-danger" onclick="deleteItem('market', ${i})" title="Ø­Ø°Ù"><i class="fas fa-trash"></i></button>
                </td>
            </tr>
        `).join('');
    }

    function saveMarketInvoice() {
        if(db.market.length === 0) return alert("Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙØ§Ø±Øº!");
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ (Ø§Ù„ÙƒÙ…ÙŠØ© Ã— Ø§Ù„Ø³Ø¹Ø±) Ù„ÙƒÙ„ ØµÙ†Ù
        const total = db.market.reduce((sum, item) => sum + (item.qty * item.price), 0);
        const invoice = {
            date: new Date().toLocaleString('ar-EG'),
            timestamp: Date.now(),
            items: [...db.market],
            total: total.toFixed(2)
        };

        db.history.unshift(invoice);
        db.market = []; 
        saveAndRender();
        alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­!");
    }

    // --- ØªØ¹Ø¯ÙŠÙ„ ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„ØªØ´Ù…Ù„ Ø§Ù„ÙƒÙ…ÙŠØ© ÙˆØ§Ù„Ø³Ø¹Ø± ---
    function editInventory(index) {
        const item = db.inventory[index];
        const newName = prompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬:", item.name);
        const newQty = prompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙ…ÙŠØ©:", item.qty);
        const newBuy = prompt("ØªØ¹Ø¯ÙŠÙ„ Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡:", item.buy);
        const newSell = prompt("ØªØ¹Ø¯ÙŠÙ„ Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹:", item.sell);

        if (newName && newQty !== null && newBuy !== null && newSell !== null) {
            db.inventory[index] = { ...item, name: newName, qty: parseFloat(newQty), buy: parseFloat(newBuy), sell: parseFloat(newSell) };
            saveAndRender();
        }
    }

    function editMarket(index) {
        const item = db.market[index];
        const newName = prompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø§Ø¯Ø©:", item.item);
        const newQty = prompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙ…ÙŠØ©:", item.qty);
        const newPrice = prompt("ØªØ¹Ø¯ÙŠÙ„ Ø³Ø¹Ø± Ø§Ù„Ù‚Ø·Ø¹Ø©:", item.price);
        if (newName && newQty !== null && newPrice !== null) {
            db.market[index] = { ...item, item: newName, qty: parseFloat(newQty), price: parseFloat(newPrice) };
            saveAndRender();
        }
    }

    // --- Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù (ÙƒÙ…Ø§ Ù‡ÙŠ) ---
    function renderHistory() {
        const list = document.getElementById('history-list');
        list.innerHTML = db.history.map((h, i) => `
            <tr>
                <td>${h.date}</td>
                <td>${h.items.length} Ù…ÙˆØ§Ø¯</td>
                <td style="color:var(--danger-color); font-weight:bold;">${h.total}</td>
                <td><button class="btn btn-info" onclick="viewInvoiceDetails(${i})">Ø¹Ø±Ø¶</button></td>
                <td><button class="btn btn-danger" onclick="deleteItem('history', ${i})">Ø­Ø°Ù</button></td>
            </tr>
        `).join('');
    }

    function viewInvoiceDetails(index) {
        const inv = db.history[index];
        let details = `ÙØ§ØªÙˆØ±Ø© Ø¨ØªØ§Ø±ÙŠØ®: ${inv.date}\n\n`;
        inv.items.forEach(item => {
            details += `- ${item.item} | Ø§Ù„ÙƒÙ…ÙŠØ©: ${item.qty} | Ø§Ù„Ø³Ø¹Ø±: ${item.price} | Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${(item.qty * item.price).toFixed(2)}\n`;
        });
        details += `\nØ¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ${inv.total}`;
        alert(details);
    }

    function addSupplier() {
        const name = document.getElementById('s-name').value;
        if(!name) return;
        db.suppliers.push({ name, phone: document.getElementById('s-phone').value });
        saveAndRender();
        document.getElementById('s-name').value = '';
        document.getElementById('s-phone').value = '';
    }

    function renderSuppliers() {
        const list = document.getElementById('suppliers-list');
        const select = document.getElementById('p-sup');
        list.innerHTML = db.suppliers.map((s, i) => `
            <tr><td>${s.name}</td><td>${s.phone}</td>
            <td><button class="btn btn-danger" onclick="deleteItem('suppliers', ${i})">Ø­Ø°Ù</button></td></tr>
        `).join('');
        select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ù…ÙˆØ±Ø¯...</option>' + 
            db.suppliers.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
    }

    function deleteItem(type, index) {
        if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ")) {
            db[type].splice(index, 1);
            saveAndRender();
        }
    }

    function saveAndRender() {
        localStorage.setItem('inv_db_v2', JSON.stringify(db.inventory));
        localStorage.setItem('market_db_v2', JSON.stringify(db.market));
        localStorage.setItem('history_db_v2', JSON.stringify(db.history));
        localStorage.setItem('sup_db_v2', JSON.stringify(db.suppliers));
        renderInventory();
        renderMarket();
        renderSuppliers();
        renderHistory();
    }

    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        document.getElementById('themeIcon').innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
    }

    window.onload = saveAndRender;
</script>

</body>
</html>